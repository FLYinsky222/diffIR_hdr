# DiffIR å­¦ä¹ ç‡è°ƒåº¦å™¨ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯
```bash
Exception has occurred: AttributeError
module 'DiffIR.models.lr_scheduler' has no attribute 'CosineAnnealingWarmupRestarts'
  File "/home/ubuntu/data_sota_disk/scripets/DiffIR/DiffIR-demotionblur/DiffIR/models/DiffIR_S1_model.py", line 78, in setup_schedulers
    lr_scheduler.CosineAnnealingWarmupRestarts(
```

### é—®é¢˜æ ¹æºåˆ†æ
1. **ç¼ºå¤±è°ƒåº¦å™¨å®ç°**ï¼šé¡¹ç›®ä»£ç ä¸­å¼•ç”¨äº† `CosineAnnealingWarmupRestarts` å’Œ `CosineAnnealingLRWithRestart` ä¸¤ä¸ªå­¦ä¹ ç‡è°ƒåº¦å™¨
2. **æ¨¡å—ä¸å®Œæ•´**ï¼š`DiffIR/models/lr_scheduler.py` æ–‡ä»¶ä¸­ç¼ºå°‘è¿™ä¸¤ä¸ªè°ƒåº¦å™¨çš„å…·ä½“å®ç°
3. **é…ç½®æ–‡ä»¶ä¾èµ–**ï¼š`options/train_DiffIRs1_hdr.yml` é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨äº† `CosineAnnealingWarmupRestarts` è°ƒåº¦å™¨

## ğŸ” é—®é¢˜å®šä½è¿‡ç¨‹

### 1. é”™è¯¯å †æ ˆåˆ†æ
- é”™è¯¯å‘ç”Ÿåœ¨è®­ç»ƒé˜¶æ®µçš„è°ƒåº¦å™¨è®¾ç½®è¿‡ç¨‹ä¸­
- å…·ä½“ä½ç½®ï¼š`DiffIR_S1_model.py` ç¬¬78è¡Œçš„ `setup_schedulers` æ–¹æ³•
- è°ƒç”¨é“¾ï¼štrain.py â†’ train_pipeline â†’ build_model â†’ DiffIRS1Model.__init__ â†’ setup_schedulers

### 2. ä»£ç è°ƒæŸ¥å‘ç°
- `lr_scheduler.py` ä¸­å·²æœ‰çš„è°ƒåº¦å™¨ï¼š
  - âœ… `MultiStepRestartLR`
  - âœ… `LinearLR`
  - âœ… `VibrateLR`
  - âœ… `CosineAnnealingRestartLR`
  - âœ… `CosineAnnealingRestartCyclicLR`
- ç¼ºå¤±çš„è°ƒåº¦å™¨ï¼š
  - âŒ `CosineAnnealingWarmupRestarts`
  - âŒ `CosineAnnealingLRWithRestart`

### 3. é…ç½®æ–‡ä»¶åˆ†æ
```yaml
# options/train_DiffIRs1_hdr.yml
scheduler:
  type: CosineAnnealingWarmupRestarts
  T_0: 100000               # ç¬¬ä¸€ä¸ªå‘¨æœŸé•¿åº¦
  T_mult: 2                 # å‘¨æœŸå€å¢
  eta_min: 1e-6             # æœ€å°å­¦ä¹ ç‡
  warmup_t: 3000            # warmup çš„è¿­ä»£æ•°
  warmup_lr_init: 1e-6      # warmup åˆå§‹å­¦ä¹ ç‡
```

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆå®æ–½

### 1. CosineAnnealingWarmupRestarts è°ƒåº¦å™¨å®ç°

**ç‰¹æ€§**ï¼š
- ç»“åˆäº† Warmup å’Œ Cosine Annealing é‡å¯æœºåˆ¶
- æ”¯æŒçº¿æ€§ Warmup é˜¶æ®µ
- æ”¯æŒå‘¨æœŸæ€§é‡å¯å’Œå‘¨æœŸå€å¢
- å®Œå…¨å…¼å®¹ PyTorch çš„ `_LRScheduler` åŸºç±»

**å…³é”®å‚æ•°**ï¼š
- `T_0`: ç¬¬ä¸€ä¸ªé‡å¯å‘¨æœŸçš„é•¿åº¦
- `T_mult`: æ¯æ¬¡é‡å¯åå‘¨æœŸé•¿åº¦çš„å€å¢å› å­
- `eta_min`: æœ€å°å­¦ä¹ ç‡
- `warmup_t`: Warmup é˜¶æ®µçš„è¿­ä»£æ•°
- `warmup_lr_init`: Warmup åˆå§‹å­¦ä¹ ç‡

**å®ç°é€»è¾‘**ï¼š
```python
def get_lr(self):
    if self.last_epoch < self.warmup_t:
        # Warmup é˜¶æ®µï¼šçº¿æ€§æ’å€¼
        return [self.warmup_lr_init + (base_lr - self.warmup_lr_init) * 
               self.last_epoch / self.warmup_t for base_lr in self.base_lrs]
    else:
        # Cosine Annealing é˜¶æ®µï¼šå‘¨æœŸæ€§é‡å¯
        # ... å¤æ‚çš„å‘¨æœŸè®¡ç®—å’Œä½™å¼¦é€€ç«é€»è¾‘
```

### 2. CosineAnnealingLRWithRestart è°ƒåº¦å™¨å®ç°

**ç‰¹æ€§**ï¼š
- åŸºäºæ ‡å‡†ä½™å¼¦é€€ç«çš„é‡å¯è°ƒåº¦å™¨
- æ”¯æŒåœ¨æŒ‡å®šè¿­ä»£ç‚¹è¿›è¡Œé‡å¯
- æ”¯æŒä¸åŒé‡å¯ç‚¹çš„æƒé‡è°ƒæ•´
- ç®€åŒ–çš„é‡å¯æœºåˆ¶

**å…³é”®å‚æ•°**ï¼š
- `T_max`: ä½™å¼¦é€€ç«çš„æœ€å¤§å‘¨æœŸé•¿åº¦
- `eta_min`: æœ€å°å­¦ä¹ ç‡
- `restart_weights`: æ¯ä¸ªé‡å¯ç‚¹çš„æƒé‡åˆ—è¡¨
- `restarts`: é‡å¯è¿­ä»£ç‚¹åˆ—è¡¨

## âœ… ä¿®å¤éªŒè¯

### 1. å¯¼å…¥æµ‹è¯•
æ‰€æœ‰è°ƒåº¦å™¨å‡å¯æ­£å¸¸å¯¼å…¥ï¼š
```
âœ… MultiStepRestartLR: å¯¼å…¥æˆåŠŸ
âœ… LinearLR: å¯¼å…¥æˆåŠŸ
âœ… VibrateLR: å¯¼å…¥æˆåŠŸ
âœ… CosineAnnealingRestartLR: å¯¼å…¥æˆåŠŸ
âœ… CosineAnnealingRestartCyclicLR: å¯¼å…¥æˆåŠŸ
âœ… CosineAnnealingWarmupRestarts: å¯¼å…¥æˆåŠŸ
âœ… CosineAnnealingLRWithRestart: å¯¼å…¥æˆåŠŸ
```

### 2. åŠŸèƒ½æµ‹è¯•
**CosineAnnealingWarmupRestarts** æµ‹è¯•ç»“æœï¼š
- Warmup é˜¶æ®µï¼šå­¦ä¹ ç‡ä» `warmup_lr_init` çº¿æ€§å¢é•¿åˆ° `base_lr`
- Cosine é˜¶æ®µï¼šæŒ‰ç…§ä½™å¼¦å‡½æ•°è¿›è¡Œå‘¨æœŸæ€§é€€ç«
- é‡å¯æœºåˆ¶ï¼šæ­£ç¡®å¤„ç†å‘¨æœŸå€å¢å’Œé‡å¯é€»è¾‘

**CosineAnnealingLRWithRestart** æµ‹è¯•ç»“æœï¼š
- ä½™å¼¦é€€ç«ï¼šåœ¨æ¯ä¸ªå‘¨æœŸå†…æ­£ç¡®æ‰§è¡Œä½™å¼¦é€€ç«
- é‡å¯åŠŸèƒ½ï¼šåœ¨æŒ‡å®šç‚¹æ­£ç¡®é‡å¯å¹¶åº”ç”¨æƒé‡è°ƒæ•´
- è¾¹ç•Œå¤„ç†ï¼šæ­£ç¡®å¤„ç†å‘¨æœŸè¾¹ç•Œå’Œé‡å¯ç‚¹

### 3. é›†æˆæµ‹è¯•
- æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­è°ƒåº¦å™¨è®¾ç½®æˆåŠŸ
- é…ç½®æ–‡ä»¶å‚æ•°æ­£ç¡®ä¼ é€’
- è®­ç»ƒè¿‡ç¨‹ä¸­å­¦ä¹ ç‡æ­£å¸¸è°ƒæ•´

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚

### å®ç°äº®ç‚¹

1. **å…¼å®¹æ€§è®¾è®¡**
   - ç»§æ‰¿è‡ª PyTorch æ ‡å‡†çš„ `_LRScheduler`
   - å®Œå…¨å…¼å®¹ç°æœ‰çš„ä¼˜åŒ–å™¨æ¥å£
   - æ”¯æŒå¤šå‚æ•°ç»„çš„ä¼˜åŒ–å™¨

2. **å‚æ•°éªŒè¯**
   - æ·»åŠ äº†å®Œæ•´çš„è¾“å…¥å‚æ•°éªŒè¯
   - æä¾›æ¸…æ™°çš„é”™è¯¯æç¤ºä¿¡æ¯
   - ç¡®ä¿å‚æ•°é…ç½®çš„åˆç†æ€§

3. **æ•°å­¦æ­£ç¡®æ€§**
   - ä¸¥æ ¼æŒ‰ç…§æ•°å­¦å…¬å¼å®ç°ä½™å¼¦é€€ç«
   - æ­£ç¡®å¤„ç†è¾¹ç•Œæ¡ä»¶å’Œç‰¹æ®Šæƒ…å†µ
   - ä¿è¯å­¦ä¹ ç‡è°ƒæ•´çš„å¹³æ»‘æ€§

4. **æ€§èƒ½ä¼˜åŒ–**
   - é«˜æ•ˆçš„å‘¨æœŸè®¡ç®—ç®—æ³•
   - é¿å…ä¸å¿…è¦çš„é‡å¤è®¡ç®—
   - ä¼˜åŒ–çš„å†…å­˜ä½¿ç”¨

### ä»£ç è´¨é‡

- **æ–‡æ¡£å®Œæ•´**ï¼šæ¯ä¸ªç±»å’Œæ–¹æ³•éƒ½æœ‰è¯¦ç»†çš„æ–‡æ¡£å­—ç¬¦ä¸²
- **æ³¨é‡Šæ¸…æ™°**ï¼šå…³é”®é€»è¾‘éƒ¨åˆ†æœ‰æ¸…æ™°çš„æ³¨é‡Šè¯´æ˜
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œå‚æ•°éªŒè¯
- **ä»£ç é£æ ¼**ï¼šéµå¾ª Python PEP8 ä»£ç é£æ ¼è§„èŒƒ

## ğŸ¯ è§£å†³æ•ˆæœ

### ä¿®å¤å‰
```bash
âŒ AttributeError: module 'DiffIR.models.lr_scheduler' has no attribute 'CosineAnnealingWarmupRestarts'
âŒ è®­ç»ƒæ— æ³•å¯åŠ¨
âŒ é¡¹ç›®åŠŸèƒ½å—é™
```

### ä¿®å¤å
```bash
âœ… æ‰€æœ‰å­¦ä¹ ç‡è°ƒåº¦å™¨æ­£å¸¸å·¥ä½œ
âœ… è®­ç»ƒå¯ä»¥æ­£å¸¸å¯åŠ¨
âœ… é…ç½®æ–‡ä»¶å®Œå…¨å…¼å®¹
âœ… åŠŸèƒ½å®Œæ•´æ€§æ¢å¤
```

## ğŸ“š å½±å“èŒƒå›´

### å—ç›Šæ¨¡å—
1. **DiffIRS1 æ¨¡å‹è®­ç»ƒ** - å¯ä»¥ä½¿ç”¨é«˜çº§å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥
2. **DiffIRS2 æ¨¡å‹è®­ç»ƒ** - æ”¯æŒæ‰€æœ‰è°ƒåº¦å™¨ç±»å‹  
3. **HDR ç›¸å…³è®­ç»ƒä»»åŠ¡** - ç‰¹åˆ«æ˜¯éœ€è¦ warmup çš„è®­ç»ƒåœºæ™¯
4. **ç ”ç©¶å’Œå®éªŒ** - æä¾›æ›´å¤šè°ƒåº¦å™¨é€‰æ‹©

### é…ç½®æ–‡ä»¶æ”¯æŒ
- âœ… `train_DiffIRs1_hdr.yml` - å®Œå…¨æ”¯æŒ
- âœ… `train_DiffIRS1.yml` - å®Œå…¨å…¼å®¹
- âœ… `train_DiffIRS2.yml` - å®Œå…¨å…¼å®¹

## ğŸ”§ ä½¿ç”¨å»ºè®®

### 1. CosineAnnealingWarmupRestarts é€‚ç”¨åœºæ™¯
- **å¤§æ¨¡å‹è®­ç»ƒ**ï¼šéœ€è¦ warmup æ¥ç¨³å®šè®­ç»ƒåˆæœŸ
- **é•¿å‘¨æœŸè®­ç»ƒ**ï¼šéœ€è¦å‘¨æœŸæ€§é‡å¯æ¥é¿å…å±€éƒ¨æœ€ä¼˜
- **ç²¾ç»†è°ƒä¼˜**ï¼šéœ€è¦å¤æ‚çš„å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥

### 2. CosineAnnealingLRWithRestart é€‚ç”¨åœºæ™¯  
- **å¤šé˜¶æ®µè®­ç»ƒ**ï¼šä¸åŒé˜¶æ®µä½¿ç”¨ä¸åŒçš„å­¦ä¹ ç‡æƒé‡
- **å®éªŒå¯¹æ¯”**ï¼šä¸å…¶ä»–è°ƒåº¦å™¨è¿›è¡Œæ€§èƒ½å¯¹æ¯”
- **ç®€å•é‡å¯**ï¼šéœ€è¦ç®€å•çš„é‡å¯æœºåˆ¶

### 3. é…ç½®å‚æ•°å»ºè®®
```yaml
# æ¨èé…ç½® 1ï¼šé•¿å‘¨æœŸè®­ç»ƒ
scheduler:
  type: CosineAnnealingWarmupRestarts
  T_0: 50000
  T_mult: 2
  eta_min: 1e-7
  warmup_t: 2000
  warmup_lr_init: 1e-7

# æ¨èé…ç½® 2ï¼šå¤šé˜¶æ®µè®­ç»ƒ
scheduler:
  type: CosineAnnealingLRWithRestart
  T_max: 10000
  eta_min: 1e-6
  restart_weights: [1.0, 0.8, 0.6, 0.4]
  restarts: [0, 10000, 20000, 30000]
```

## ğŸš€ æ€»ç»“

æœ¬æ¬¡ä¿®å¤æˆåŠŸè§£å†³äº† DiffIR é¡¹ç›®ä¸­å­¦ä¹ ç‡è°ƒåº¦å™¨ç¼ºå¤±çš„é—®é¢˜ï¼Œå…·ä½“æˆæœåŒ…æ‹¬ï¼š

1. **å®Œæ•´å®ç°**ï¼šæ·»åŠ äº†ä¸¤ä¸ªå…³é”®çš„å­¦ä¹ ç‡è°ƒåº¦å™¨
2. **åŠŸèƒ½éªŒè¯**ï¼šé€šè¿‡å…¨é¢æµ‹è¯•ç¡®ä¿åŠŸèƒ½æ­£ç¡®æ€§
3. **å…¼å®¹æ€§ä¿è¯**ï¼šä¸ç°æœ‰ä»£ç å’Œé…ç½®å®Œå…¨å…¼å®¹
4. **æ–‡æ¡£å®Œå–„**ï¼šæä¾›è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜å’ŒæŠ€æœ¯æ–‡æ¡£

è¯¥ä¿®å¤æ˜¾è‘—æå‡äº†é¡¹ç›®çš„å®Œæ•´æ€§å’Œå¯ç”¨æ€§ï¼Œä¸ºç”¨æˆ·æä¾›äº†æ›´å¤šé«˜çº§çš„å­¦ä¹ ç‡è°ƒåº¦é€‰æ‹©ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦ warmup å’Œå‘¨æœŸæ€§é‡å¯çš„è®­ç»ƒåœºæ™¯ä¸­ã€‚

## ğŸ“ ç»´æŠ¤å»ºè®®

1. **å®šæœŸæµ‹è¯•**ï¼šåœ¨æ¯æ¬¡é¡¹ç›®æ›´æ–°åè¿è¡Œè°ƒåº¦å™¨æµ‹è¯•
2. **å‚æ•°éªŒè¯**ï¼šåœ¨ä½¿ç”¨æ–°é…ç½®å‰å…ˆè¿›è¡Œå°è§„æ¨¡æµ‹è¯•
3. **æ€§èƒ½ç›‘æ§**ï¼šå…³æ³¨ä¸åŒè°ƒåº¦å™¨å¯¹è®­ç»ƒæ•ˆæœçš„å½±å“
4. **æ–‡æ¡£æ›´æ–°**ï¼šåŠæ—¶æ›´æ–°ç›¸å…³çš„ä½¿ç”¨æ–‡æ¡£å’Œç¤ºä¾‹

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š$(date)  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… å®Œæˆ  
**æµ‹è¯•ç»“æœ**ï¼šâœ… é€šè¿‡  
**éƒ¨ç½²çŠ¶æ€**ï¼šâœ… å°±ç»ª 